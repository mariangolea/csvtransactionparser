package com.mariangolea.fintracker.banks.csvparser.cmdsupport;

import java.io.File;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

/**
 * Command line support for parsing supported arguments.
 */
public class CmdArgParser {

    /**
    Option to specify a input folder.
     */
    public static final String INPUT_FOLDER_ARG = "-folder";
    /**
    Option/value separator.
     */
    public static final String FOLDER_NAME_SEPARATOR = "=";
    /**
    Paths may be escaped if they contain empty spaces.
     */
    public static final String FOLDER_PATH_ESCAPE = "\"";
    /**
    Supported file extension. All files contained in input folders will be parsed.
     */
    public static final String SUPPORTED_FILE_EXTENSION = ".csv";

    /**
     * Retrieve the list of all .csv files found in the folders specified in
     * command line.
     * <br> Folder specification needs to adhere to the format:
     * -folder="somefolder".
     *
     * @param args list of strings each depicting one single folder definition.
     * @return all csv files found in all received folders.
     */
    public List<File> getCSVFiles(final String[] args) {
        if (args == null || args.length < 1) {
            printError();
            return null;
        }

        final List<File> folderFiles = getFolderFiles(args);
        if (folderFiles == null) {
            return null;
        }

        final List<File> csvFiles = new ArrayList<>();

        folderFiles.forEach(folderFile -> {
            File[] csvsPerFolder = folderFile.listFiles((File dir, String name) -> {
                return name.endsWith(SUPPORTED_FILE_EXTENSION);
            });
            csvFiles.addAll(Arrays.asList(csvsPerFolder));

        });

        return csvFiles;
    }

    private void printError() {
        System.out.println("Please input the path to a folder which contains CSV reports generated by supported banks (only ING for now).");
        System.out.println("Absolute folder path needs to be specified: -folder=\"pathOnYourOperatingSystem\" ");
        System.out.println("-inputFolder can be used multiple times to designate more folders: -folder=\"sss\" -folder=\"fff\"");
    }

    /**
    Get the File instances corresponding to all folders specified in this arg array.
    @param args arg array received by the cmd entry point.
    @return 
     */
    public List<File> getFolderFiles(String[] args) {
        final List<File> folderFiles = new ArrayList<>();
        for (String arg : args) {
            String[] argParams = arg.split(FOLDER_NAME_SEPARATOR);
            if (argParams.length != 2 || !INPUT_FOLDER_ARG.equals(argParams[0])) {
                printError();
                return null;
            }

            String folderPath = argParams[1].replaceAll("\"", "");
            File folderFile = new File(folderPath);
            if (!folderFile.exists() || !folderFile.isDirectory()) {
                printError();
                return null;
            } else {
                folderFiles.add(folderFile);
            }
        }

        return folderFiles;
    }
}
